{% extends 'base.html' %}
{% block title %}{{ post.title }}{% endblock %}
{% load crispy_forms_tags %} 
{% load static %}
{% block content %}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="{% url 'post_list' %}">Session</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="#"><i class="bi bi-house h4" title="Home"></i> <span class="sr-only">(current)</span></a>
        </li>
        {% if user.is_authenticated %}
        <li class="nav-item">
          <a class="nav-link actions" href="#"><i class="bi bi-chat-dots h4" title="Messages"></i></a>
        </li>
        {% endif %}
        <li class="nav-item">
          <a class="nav-link actions" href="#"><i class="bi bi-columns h4" title="For You"></i></a>
        </li>
        {% if user.is_authenticated %}
        <li class="nav-item">
          <a href="{% url 'create_post' %}" class="nav-link new-post"><i class="bi bi-plus-circle h4" title="New Post"></i></a>
        </li>
        {% endif %}
      </ul>
      {% if user.is_authenticated %}
      <span class="navbar-text">
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            {{ user.username }}
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item profile" href="#"><i class="bi bi-person"></i>Profile</a>
            <a class="dropdown-item profile" href="#"><i class="bi bi-gear"></i>Settings</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item logout" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right"></i>Logout</a>
          </div>
        </div>
      </span>
      {% else %}
      <span class="navbar-text">
        <form class="form-inline">
          <button class="btn btn-success login" type="button"><a href="{% url 'login' %}" class="login-link">Login</a></button>
          <button class="btn btn-primary register" type="button"><a href="{% url 'register' %}" class="login-link">Register</a></button>
        </form>
      </span>
      {% endif %}
    </div>
</nav>



<div class="container" style="margin-top: 20px;">
    <div class="card post-card">
        <div class="card-header">
            <img src="{{ user.profile.profile_picture.url }}" class="mr-3 rounded-circle article-img" alt="User image" style="height: 64px;"><a href="{% url 'profile' post.author.username %}" class="author">{{ post.author }}</a>
        {% if user.is_authenticated %}
        {% if request.user != post.author %}
        <span class="follow-button">
            <button class="btn btn-primary"><i class="bi bi-plus-lg"></i>Follow</button>
        </span>
        {% endif %}
        {% endif %}
        </div>
        <div class="card-body">
        <h5 class="card-title">{{ post.title }}</h5>
        <p class="card-text">{{ post.content }}</p>
            {% if request.user in post.likes.all %}
            <a href="{% url 'like_post' post.id %}" class="card-link"><i class="bi bi-heart-fill h5"></i></a>&nbsp;{{ post.number_of_likes }}
            {% else %}
            <a href="{% url 'like_post' post.id %}" class="card-link"><i class="bi bi-heart h5"></i></a>&nbsp;{{ post.number_of_likes }}
            {% endif %}
            <a href="{% url 'post_detail' post.id %}" class="card-link"><i class="bi bi-chat h5"></i></a>&nbsp;{{ comments_count }}
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        {{ comment_form|crispy }}
        <button type="submit" class="btn btn-primary" style="margin-left: 171px;">comment</button>
    </form>
</div>

{% for comment in comments %}
<div class="container" style="max-width: 768px; margin-top: 50px;">
    <div class="media mb-4">
        <img src="{{ user.profile.profile_picture.url }}" class="mr-3 rounded-circle article-img" alt="User image" style="height: 64px;">
        <div class="media-body">
            <h5 class="mt-0">{{ comment.author.username }}</h5>
            <p>{{ comment.content }} &nbsp;&nbsp; {% if request.user in comment.liked_by.all %}
            <a href="{% url 'like_comment' comment.id %}" class="card-link"><i class="bi bi-heart-fill h5"></i></a>&nbsp;{{ comment.like_count }}
            {% else %}
            <a href="{% url 'like_comment' comment.id %}" class="card-link"><i class="bi bi-heart h5"></i></a>&nbsp;{{ comment.like_count }}
            {% endif %} </p>
            <a  data-toggle="collapse" href="#collapseExample{{ comment.id }}" role="button" aria-expanded="false" aria-controls="collapseExample">reply</a><br>
            <small class="text-muted">Posted on {{ comment.created_at }}</small>



            <div class="collapse" id="collapseExample{{ comment.id }}" style="margin-top: 15px;">
              <form method="POST" action="{% url 'post_detail' post.id %}">
                {% csrf_token %}
                <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                <textarea name="content" class="form-control" placeholder="Reply to this comment..."></textarea>
                <button class="btn btn-primary" type="submit" style="margin-top: 5px;">Reply</button>
              </form>
            </div>

            {% include '_comment_replies.html' with comment=comment %}

            {% for reply in comment.replies.all %}
            <div class="media mt-3">
              <a class="mr-3" href="#">
                <img src="{{ user.profile.profile_picture.url }}" class="mr-3 rounded-circle article-img" alt="User image" style="height: 64px;">
              </a>
              {% for reply in comment.replies.all %}
              <div class="media-body">
                <h5 class="mt-0">{{ reply.author }}</h5>
                 {{ reply.content }}
                 <br><a  data-toggle="collapse" href="#collapseExample{{ reply.id }}" role="button" aria-expanded="false" aria-controls="collapseExample">reply</a>

                 <div class="collapse" id="collapseExample{{ reply.id }}" style="margin-top: 15px;">
                    <form method="POST" action="{% url 'post_detail' post.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="parent_comment" value="{{ reply.id }}">
                      <textarea name="content" class="form-control" placeholder="Reply to this comment..."></textarea>
                      <button class="btn btn-primary" type="submit" style="margin-top: 5px;">Reply</button>
                    </form>
                  </div>
              </div>
              {% endfor %}
            </div>
            {% endfor %}



        </div>
    </div>
</div>
    {% endfor %}
{% endblock %}